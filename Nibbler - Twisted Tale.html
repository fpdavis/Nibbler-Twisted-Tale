<HTML>
<HEAD>
    <meta content="text/html; charset=ISO-8859-1" http-equiv="content-type">
    <TITLE>Nibbler - Twisted Tale</TITLE>

    <STYLE>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0px;
            border: 0;
            overflow: hidden; /*  Disable scrollbars */
            display: block;
        }
    </STYLE>

</HEAD>

<BODY>

    <canvas id="canArena"></canvas>

    <script>
        window.onload = function () {
            canvArena = document.getElementById("canArena");
            ctxArena = canvArena.getContext("2d");
            canvArena.focus();

			ogPlayer = new Array(4);
         
		    InitializePlayers(ogPlayer);
			
			ogPellet = new Pellet();
		 	ogPellet.SetPosition();
			
            ResizeEvent();
			
			for (var iLoop = ogPlayer.length; iLoop--; ) // Reverse loop for the win
			{
				DrawPlayer(ogPlayer[iLoop]);
            }

            window.addEventListener('resize', ResizeEvent, false);
            document.addEventListener("keydown", KeydownEvent);
            document.addEventListener("click", ClickEvent);
            setInterval(GameLoop, 66);

        }

        giGridSize = 40;
        giMinimumTailLength = 3;
        gbGamePaused = true; 

        giArenaSquaresX = Math.floor(window.innerWidth / giGridSize);
        giArenaSquaresY = Math.floor(window.innerHeight / giGridSize);

        // Define Sounds
        var Sounds = {
            Bite: new Audio('Sounds/Bite-SoundBible.com-2056759375.mp3'),
            Pause: new Audio('Sounds/Splat And Squirt-SoundBible.com-2136633229.mp3'),
            Crawlig: new Audio('Sounds/termites_and_ants-mike-koenig.mp3')
        }
        
        function Nibbler() {
			this.Name = "Player ";
            this.PositionX = 0;
            this.PositionY = 0;

            this.DirectionX = 0;
            this.DirectionY = 0;

            this.Trail = [];
            this.TailLength = giMinimumTailLength;

            this.KeyLeft = 37; // Left Arrow
            this.KeyUp = 38; // Up Arrow
            this.KeyRight = 39; // Right Arrow
            this.KeyDown = 40; // Down Arrow

            this.fillStyle = "lime";
        }
        Nibbler.prototype.UpdateTail = function () {
            this.Trail.push({ x: this.PositionX, y: this.PositionY });

            while (this.Trail.length > this.TailLength) {
                this.Trail.shift();
            }
        }        
        Nibbler.prototype.SetSpawnPoint = function () {
            this.PositionX = Math.floor(Math.random() * (giArenaSquaresX - 2)) + 1;
            this.PositionY = Math.floor(Math.random() * (giArenaSquaresY - 2)) + 1;

			// Don't spawn on top of another player
			for (var iLoop = ogPlayer.length; iLoop--; ) // Reverse loop for the win
			{
				if (ogPlayer[iLoop] != null && this.Name != ogPlayer[iLoop].Name 
					&& this.PositionX === ogPlayer[iLoop].PositionX 
					&& this.PositionY === ogPlayer[iLoop].PositionY) {
						this.SetSpawnPoint();
				}
			}
        }
		
		function Pellet() {
			this.PositionX = 0;
			this.PositionY = 0;
			
			this.Sound = new Audio(Sounds.Bite.src);
			this.strokeStyle = "grey";
			this.fillStyle = "Red";
		}
        Pellet.prototype.SetPosition = function () {
            this.PositionX = Math.floor(Math.random() * (giArenaSquaresX - 2)) + 1;
            this.PositionY = Math.floor(Math.random() * (giArenaSquaresY - 2)) + 1;

			for (var iLoop = ogPlayer.length; iLoop--; ) // Reverse loop for the win
			{
				if (this.PositionX === ogPlayer[iLoop].PositionX && this.PositionY === ogPlayer[iLoop].PositionY) 
				{
					this.SetPosition();
				}
			}
        }
        Pellet.prototype.Eatten = function (oPlayer) {
				this.Sound.play();
                this.SetPosition();
				oPlayer.TailLength++;
        }
	
	function InitializePlayers(ogPlayer)
	{						
		for (var iLoop = ogPlayer.length; iLoop--; ) // Reverse loop for the win
			{
				ogPlayer[iLoop] = new Nibbler();
				ogPlayer[iLoop].Name += iLoop;
				ogPlayer[iLoop].SetSpawnPoint();
			}
			
			if (ogPlayer.length > 1)
			{
				// Override Player Two Input Keys
				ogPlayer[1].KeyLeft = 65; // "A"
				ogPlayer[1].KeyUp = 87; // "W"
				ogPlayer[1].KeyRight = 68; // "D"
				ogPlayer[1].KeyDown = 83; // "S"
				ogPlayer[1].fillStyle = "yellow";
			}
			
			if (ogPlayer.length > 2)
			{
				// Override Player Two Input Keys
				ogPlayer[2].KeyLeft = 74; // "A"
				ogPlayer[2].KeyUp = 73; // "W"
				ogPlayer[2].KeyRight = 76; // "D"
				ogPlayer[2].KeyDown = 75; // "S"
				ogPlayer[2].fillStyle = "BlueViolet ";
			}
			
			if (ogPlayer.length > 3)
			{
				// Override Player Two Input Keys
				ogPlayer[3].KeyLeft = 100; // "A"
				ogPlayer[3].KeyUp = 104; // "W"
				ogPlayer[3].KeyRight = 102; // "D"
				ogPlayer[3].KeyDown = 101; // "S"
				ogPlayer[3].fillStyle = "HotPink ";
			}
	}
	
		function GameLoop() {
            if (gbGamePaused) {
                return;
            }

			for (var iLoop = ogPlayer.length; iLoop--; ) // Reverse loop for the win
			{
				HandlePlayer(ogPlayer[iLoop]);
            }

            DrawGrid();

			for (var iLoop = ogPlayer.length; iLoop--; ) // Reverse loop for the win
			{
				DrawPlayer(ogPlayer[iLoop]);
				ogPlayer[iLoop].UpdateTail();
			}
        }

        function HandlePlayer(oPlayer) {

            if (oPlayer.DirectionX === 0 && oPlayer.DirectionY === 0) {
                return;
            }

            oPlayer.PositionX += oPlayer.DirectionX;
            oPlayer.PositionY += oPlayer.DirectionY;

            if (oPlayer.PositionX < 1) {
                oPlayer.PositionX = giArenaSquaresX - 1;
            } else if (oPlayer.PositionX >= giArenaSquaresX) {
                oPlayer.PositionX = 1;
            } else if (oPlayer.PositionY < 1) {
                oPlayer.PositionY = giArenaSquaresY - 1;
            } else if (oPlayer.PositionY > giArenaSquaresY - 1) {
                oPlayer.PositionY = 1;
            }

            // Check to see if the pellet was eaten
            if (ogPellet.PositionX === oPlayer.PositionX && ogPellet.PositionY === oPlayer.PositionY) {
                ogPellet.Eatten(oPlayer);
				delete ogPellet;
				ogPellet = new Pellet();
				ogPellet.SetPosition();
            }
        }

        function KeydownEvent(oEvent) {

			if (CheckForSpecialKeys(oEvent))
			{
				return;
			}
			else
			{
				for (var iLoop = ogPlayer.length; iLoop--; ) // Reverse loop for the win
				{
					if (CheckForKeyEvents(oEvent, ogPlayer[iLoop]))
					{
						break;
					}				
				}   
			}			
        }
        function CheckForSpecialKeys(oEvent) {

            switch (oEvent.keyCode) {
             case 32: // Space
             case 80: // "P"
                // Pause/unPause
                 window.gbGamePaused = !gbGamePaused;
                 if (gbGamePaused) {
                     Sounds.Crawlig.pause();
                     Sounds.Pause.play();
                     DrawBegin();
                 }
                 else {
                     Sounds.Crawlig.play();
                     Sounds.Crawlig.loop = true;
                 }
                 break;
            default:
                return false;
            }

            return true;
        }
        function CheckForKeyEvents(oEvent, oPlayer) {
            
            switch (oEvent.keyCode) {
                case oPlayer.KeyLeft:
                    oPlayer.DirectionX = -1;
                    oPlayer.DirectionY = 0;
                    break;
                case oPlayer.KeyUp:
                    oPlayer.DirectionX = 0;
                    oPlayer.DirectionY = -1;
                    break;
                case oPlayer.KeyRight:
                    oPlayer.DirectionX = 1;
                    oPlayer.DirectionY = 0;
                    break;
                case oPlayer.KeyDown:
                    oPlayer.DirectionX = 0;
                    oPlayer.DirectionY = 1;
                    break;
                default:
                    return false;
            }

            return true;
        }
        function ClickEvent(event) {

            if (gbGamePaused) {
                window.gbGamePaused = false;
                Sounds.Crawlig.play();
                Sounds.Crawlig.loop = true;

                return;
            }

            var iXOffset = Math.abs(ogPlayer[0].PositionX * giGridSize - event.pageX);
            var iYOffset = Math.abs(ogPlayer[0].PositionY * giGridSize - event.pageY);

            if (iXOffset >= iYOffset && ogPlayer[0].PositionX * giGridSize < event.pageX) {
                ogPlayer[0].DirectionX = 1;
                ogPlayer[0].DirectionY = 0;
            }
            else if (iXOffset >= iYOffset) {
                ogPlayer[0].DirectionX = -1;
                ogPlayer[0].DirectionY = 0;
            }
            else if (iXOffset < iYOffset && ogPlayer[0].PositionY * giGridSize < event.pageY) {
                ogPlayer[0].DirectionY = 1;
                ogPlayer[0].DirectionX = 0;
            }
            else if (iXOffset < iYOffset) {
                ogPlayer[0].DirectionY = -1;
                ogPlayer[0].DirectionX = 0;
            }
        }

        function ResizeEvent() {
            // Runs each time the DOM window resize event fires.
            // Resets the canvas dimensions to match window,
            // then draws the new borders accordingly.
            canvArena.width = window.innerWidth;
            canvArena.height = window.innerHeight;

            window.giArenaSquaresX = Math.floor(window.innerWidth / giGridSize);
            window.giArenaSquaresY = Math.floor(window.innerHeight / giGridSize);

            DrawGrid();
        }
        function DrawGrid() {
            ctxArena.fillStyle = "black";
            ctxArena.fillRect(0, 0, window.innerWidth, window.innerHeight);

            ctxArena.strokeStyle = 'orange';
            ctxArena.lineWidth = giGridSize / 2;
            ctxArena.strokeRect(0, 0, window.innerWidth, window.innerHeight);

            DrawPellet();

            if (gbGamePaused) {
                DrawBegin();
            }
        }
        function DrawPlayer(oPlayer) {
            ctxArena.fillStyle = oPlayer.fillStyle;

            if (oPlayer.Trail.length === 0) {
                ctxArena.fillRect(oPlayer.PositionX * giGridSize, oPlayer.PositionY * giGridSize, giGridSize - 2, giGridSize - 2);
            }
            else {
                for (var iLoop = 0; iLoop < oPlayer.Trail.length; iLoop++) {
                    ctxArena.fillRect(oPlayer.Trail[iLoop].x * giGridSize, oPlayer.Trail[iLoop].y * giGridSize, giGridSize - 2, giGridSize - 2);

                    // Check to see if the player encountered their tale
                    if (oPlayer.Trail[iLoop].x === oPlayer.PositionX && oPlayer.Trail[iLoop].y === oPlayer.PositionY) {
                        oPlayer.TailLength = giMinimumTailLength;
                    }
                }
            }
        }
        function DrawPellet() {

            // Draw the pellet
            ctxArena.lineWidth = 2;
            ctxArena.strokeStyle = ogPellet.strokeStyle;
            ctxArena.fillStyle = ogPellet.fillStyle;
            ctxArena.beginPath();
            ctxArena.arc(ogPellet.PositionX * giGridSize + (giGridSize / 2), ogPellet.PositionY * giGridSize + (giGridSize / 2), giGridSize / 2.8, 0, 2 * Math.PI);
            ctxArena.fill();
            ctxArena.stroke();
        }
        function DrawBegin() {
            ctxArena.font = giGridSize + "px Comic Sans MS";
            ctxArena.fillStyle = "blue";
            ctxArena.textAlign = "center";
            ctxArena.fillText("Click to Begin", window.innerWidth / 2, window.innerHeight / 2);
        }

    </script>
</BODY>
</HTML>
