<HTML>
<HEAD>
    <meta content="text/html; charset=ISO-8859-1" http-equiv="content-type">

    <TITLE>Nibbler - Twisted Tale</TITLE>

    <STYLE>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            border: 0;
            overflow: hidden; /*  Disable scrollbars */
            display: block;
            background-color: #000;
            cursor: crosshair;
        }

        .wrapper {
            display: grid;
            border: 1px solid #000;
            grid-gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
        }

        .box {
            background-color: #000;
            color: #fff;
            padding: 10px;
            font-size: 150%;
        }

        .blink_me {
            animation: blinker 1s linear infinite;
        }

        @keyframes blinker {  
            50% { opacity: 0; }
        }
        
    </STYLE>

</HEAD>

<BODY>
<div id="divScoreboard">
    <div class="wrapper">
        <div id="divPlayer" class="box">Player 1</div>
        <div id="divScore" class="box">000</div>
        <div id="divLives" class="box">Lives</div>
    </div>
    <div class="wrapper">
        <div id="divHighScorePlayer" class="box">HIGHSCORE (Player 1)</div>
        <div id="divHighScore" class="box">000</div>
        <div id="divTime" class="box blink_me">TIME ---</div>
    </div>
</div>


<canvas id="canArena"></canvas>

<style>
        svg {
            width: 560px;
            position: relative;
            height: 380px;
            margin: 0 auto;
            display: block;
        }

            svg line {
                stroke-width: 2px;
                stroke: rgba(2,162,239,1);
            }

            svg #svg_2 {
                stroke-dasharray: 1680;
                stroke-dashoffset: 1680;
            }

            svg #svg_4 {
                stroke-dasharray: 1680;
                stroke-dashoffset: -380;
            }

            svg #svg_3 {
                stroke-dasharray: 1680;
                stroke-dashoffset: -580;
            }

            svg #svg_5 {
                stroke-dasharray: 1680;
                stroke-dashoffset: -380;
            }

        @keyframes anim-dash {
            90% {
                stroke: rgba(2,162,239,1);
            }

            100% {
                stroke: #ffffff;
                stroke-dashoffset: 0;
                opacity: 1;
            }
        }

        .overlay {
            background: rgba(0,0,0,.5);
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            z-index: -999;
        }

        .modal {
            position: absolute;
            width: 560px;
            height: 380px;
            top: 50%;
            left: 70%;
            transform: translate(-100%,-40%);
        }

    .modal-inner {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 554px;
        height: 374px;
        color: #ffffff;
        background-color: rgba(60, 60, 60, 0.4);
        opacity: 0;
    }

        .modal-start {
            float: right;
            z-index: +2;
            color: #424242;
            margin: 5px 5px 0 0;
            font-size: 20px;
            font-weight: bold;
            text-decoration: none;
            text-align: center;
            line-height: 20px;
        }

    .modal-inner h3 {
        display: block;
        text-align: center;
        font-size: 22px;
        padding: 10px 10px 10px 10px;
    }

        .modal-blur {
            -webkit-filter: blur(2px);
            -moz-filter: blur(2px);
            -o-filter: blur(2px);
            -ms-filter: blur(2px);
            filter: blur(2px);
        }

        .showGameMenu .modal, .showGameMenu {
            animation: display .6s forwards;
            z-index: auto;
        }

            .showGameMenu .modal svg line {
                animation: anim-dash .6s forwards;
                animation-delay: .6s;
            }

            .showGameMenu .modal .modal-inner {
                animation: display .6s forwards;
                animation-delay: 1s;
            }

        @keyframes display {
            to {
                opacity: 1;
            }
        }
    </style>

        <div class="overlay" id="divGameMenu">
            <div class="modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 560 380" preserveAspectRatio="true">
                    <line id="svg_3" fill="none" stroke="#000000" stroke-width="2" x1="2.0" y1="2.0" x2="558" y2="2.0" />
                    <line id="svg_4" fill="none" stroke="#000000" stroke-width="2" x1="558" y1="378" x2="558" y2="2.0" />
                    <line id="svg_2" fill="none" stroke="#000000" stroke-width="2" x1="2.0" y1="378" x2="558" y2="378" />
                    <line id="svg_5" fill="none" stroke="#000000" stroke-width="2" x1="2.0" y1="2.0" x2="2.0" y2="378" />
                </svg>
                <div class="modal-inner">
                    <h3>Game Options</h3>
                    Player 1: <select id="selectPlayer1"><option selected>Human</option><option>Computer</option></select>
                    Name: <input id="txtPlayer1Name" type="text" value="Player 1" maxlength="10" size="10" />
                    
                    <br />Player 2: <select id="selectPlayer2"><option>Human</option><option>Computer</option><option selected>None</optionselected></select>
                    Name: <input id="txtPlayer2Name" type="text" value="Player 2" maxlength="10" size="10" />
                    
                    <br />Player 3: <select id="selectPlayer3"><option>Human</option><option>Computer</option><option selected>None</option></select>
                    Name: <input id="txtPlayer3Name" type="text" value="Player 3" maxlength="10" size="10" />
                    
                    <br />Player 4: <select id="selectPlayer4"><option>Human</option><option>Computer</option><option selected>None</option></select>
                    Name: <input id="txtPlayer4Name" type="text" value="Player 4" maxlength="10" size="10" />

                    <br />Timer: <select id="selectTime">
                        <option value="true" selected>On</option>
                        <option value="false">Off</option>
                    </select> Time:
                    <input type="number" id="numberTime" min="30" max="480" value="120" step="10" />

                    <br />Lives:
                    <input type="range" id="rangeLives" min="1" max="10" value="3" oninput="this.nextElementSibling.value=this.value" />
                    <input type="number" id="numberLives" min="1" max="10" value="3" oninput="this.previousElementSibling.value=this.value" />

                    <br />Wall Wrap: <select id="selectWallWrap"><option>On</option><option selected>Off</option></select>
                    <br />Deadly Walls: <select id="selectDeadlyWalls"><option>On</option><option selected>Off</option></select>
                    <br />Deadly Tails: <select id="selectDeadlyTails"><option>On</option><option selected>Off</option></select>
                    <br />Diagonal Movement: <select id="selectDiagonalMovement"><option>On</option><option selected>Off</option></select>
                    <br />Maze: <select id="selectMaze"><option>On</option><option selected>Off</option></select>
                    <br />Enemies: <select id="selectEnemies"><option>On</option><option selected>Off</option></select>
                    <br />Dificulty: <select id="selectDificulty"><option>Easy</option><option selected>Medium</option><option>Hard</option></select>
                                     <input type="button" id="btnStart" Value="Start" class="modal-start" onclick="StartGame();" />
                    <br />Speed: <select id="selectSpeed"><option>Slow</option><option selected>Normal</option><option>Fast</option></select>

                    </div>
            </div>
        </div>


    <script>
        window.onload = function () {
            
            window.addEventListener('resize', ResizeEvent, false);
            document.addEventListener("keydown", KeydownEvent);
            document.addEventListener("click", ClickEvent);
            
            addClass(oDivGameMenu, "showGameMenu");
            addClass(oDivScoreboard, "modal-blur");
            addClass(canvArena, "modal-blur");
        }

        const canvArena = document.getElementById("canArena");
        const ctxArena = canvArena.getContext("2d");
        const oDivPlayer = document.getElementById('divPlayer');
        const oDivScore = document.getElementById('divScore');
        const oDivLives = document.getElementById('divLives');
        const oDivHighScorePlayer = document.getElementById('divHighScorePlayer');
        const oDivHighScore = document.getElementById('divHighScore');
        const oDivTime = document.getElementById('divTime');
        const oDivGameMenu = document.getElementById('divGameMenu');
        const oDivScoreboard = document.getElementById('divScoreboard');

        const oSelectPlayer1 = document.getElementById('selectPlayer1');
        const oSelectPlayer2 = document.getElementById('selectPlayer2');
        const oSelectPlayer3 = document.getElementById('selectPlayer3');
        const oSelectPlayer4 = document.getElementById('selectPlayer4');

        const oNumberLives = document.getElementById('numberLives');
        const oSelectTime = document.getElementById('selectTime');
        const oNumberTime = document.getElementById('numberTime');
        const oSelectWallWrap = document.getElementById('selectWallWrap');
        const oSelectDeadlyWalls = document.getElementById('selectDeadlyWalls');
        const oSelectDeadlyTails = document.getElementById('selectDeadlyTails');
        const oSelectDiagonalMovement = document.getElementById('selectDiagonalMovement');
        const oSelectMaze = document.getElementById('selectMaze');
        const oSelectEnemies = document.getElementById('selectEnemies');
        const oSelectDificulty = document.getElementById('selectDificulty');
        const oSelectSpeed = document.getElementById('selectSpeed');
        const oBtnStart = document.getElementById('btnStart');

        var giGameLoopSpeed;
        var giGridSize;
        var giGridHeight = window.innerHeight - oDivScoreboard.offsetHeight;
        var giMinimumTailLength = 3;
        var gbGamePaused = true;
        var ogPlayer;
        var ogPellet;
        var ogCountDownTime;
        var ogCountdownTimer;
        var giTimeRemaining;
        var ogGameLoop;
        var gbWallWrap;
        var gbDeadlyWalls;
        var gbDeadlyWallsDeadlyTails;
        var gbDiagonalMovement;

        var giArenaSquaresX;
        var giArenaSquaresY;

        // Define Sounds
        var Sounds = {
            Bite: new Audio('Sounds/Bite-SoundBible.com-2056759375.mp3'),
            Pause: new Audio('Sounds/Splat And Squirt-SoundBible.com-2136633229.mp3'),
            Crawlig: new Audio('Sounds/termites_and_ants-mike-koenig.mp3')
        }

        function Nibbler() {
            this.Name = "Player ";
            this.Lives = 3;
            this.Score = 0;
            this.Dead = false;

            this.PositionX = 0;
            this.PositionY = 0;

            this.DirectionX = 0;
            this.DirectionY = 0;

            this.Trail = [];
            this.TailLength = giMinimumTailLength;

            this.KeyLeft = 37; // Left Arrow
            this.KeyUp = 38; // Up Arrow
            this.KeyRight = 39; // Right Arrow
            this.KeyDown = 40; // Down Arrow

            this.fillStyle = "lime";
        }

        Nibbler.prototype.UpdateTail = function () {
            this.Trail.push({ x: this.PositionX, y: this.PositionY });

            while (this.Trail.length > this.TailLength) {
                this.Trail.shift();
            }
        }
        Nibbler.prototype.SetSpawnPoint = function () {
            this.PositionX = Math.floor(Math.random() * (giArenaSquaresX - 2)) + 1;
            this.PositionY = Math.floor(Math.random() * (giArenaSquaresY - 2)) + 1;

            // Don't spawn on top of another player
            for (let iLoop = ogPlayer.length; iLoop--;) // Reverse loop for the win
            {
                if (ogPlayer[iLoop] != null &&
                    this !== ogPlayer[iLoop] &&
                    this.PositionX === ogPlayer[iLoop].PositionX &&
                    this.PositionY === ogPlayer[iLoop].PositionY) {
                    this.SetSpawnPoint();
                }
            }
        }
        Nibbler.UpdateTail = function (oNibbler) { oNibbler.UpdateTail(); }

        function Pellet() {
            this.Name = "Pellet";
            this.Points = 10;
            this.TailAdjustment = 1;

            this.PositionX = 0;
            this.PositionY = 0;

            this.Sound = new Audio(Sounds.Bite.src);
            this.strokeStyle = "grey";
            this.fillStyle = "Red";
        }
        Pellet.prototype.SetSpawnPoint = function () {
            this.PositionX = Math.floor(Math.random() * (giArenaSquaresX - 2)) + 1;
            this.PositionY = Math.floor(Math.random() * (giArenaSquaresY - 2)) + 1;

            // Don't spawn on top a player
            for (let iLoop = ogPlayer.length; iLoop--;) // Reverse loop for the win
            {
                if (this.PositionX === ogPlayer[iLoop].PositionX && this.PositionY === ogPlayer[iLoop].PositionY) {
                    this.SetSpawnPoint();
                }
            }

            // Don't spawn on top of another pellet
            for (let iLoop = ogPellet.length; iLoop--;) // Reverse loop for the win
            {
                if (ogPellet[iLoop] != null &&
                    this !== ogPellet[iLoop] &&
                    this.PositionX === ogPellet[iLoop].PositionX &&
                    this.PositionY === ogPellet[iLoop].PositionY) {
                    this.SetSpawnPoint();
                }
            }

        }
        Pellet.prototype.Eatten = function (oPlayer) {
            this.Sound.play();
            this.SetSpawnPoint();
            oPlayer.TailLength += this.TailAdjustment;
            oPlayer.Score += this.Points;
        }

        function StartGame() {
            
            switch (oSelectDificulty.value) {
            case "Easy":
                giGridSize = 60;
                break;
            case "Hard":
                giGridSize = 30;
                break;
            default:
                giGridSize = 40;
            }
            
            giArenaSquaresX = Math.floor(window.innerWidth / giGridSize);
            giArenaSquaresY = Math.floor(giGridHeight / giGridSize);

            let iNumberOfPlayers = 1;
            
            if (oSelectPlayer2.value !== "None") iNumberOfPlayers++;
            if (oSelectPlayer3.value !== "None") iNumberOfPlayers++;
            if (oSelectPlayer4.value !== "None") iNumberOfPlayers++;

            ogPlayer = new Array(iNumberOfPlayers);
            InitializePlayers(ogPlayer);
            ogPlayer.map(function(oPlayer) { oPlayer.Lives = oNumberLives.value; });
            ogPellet = new Array(ogPlayer.length + 1);
            InitializePellets(ogPellet);

            ResizeEvent();

            ogPlayer.forEach(DrawPlayer);
            
            giTimeRemaining = 1000 * oNumberTime.value; // 1,000 ms per second

            switch (oSelectSpeed.value) {
                case "Slow":
                    giGameLoopSpeed = 120;
                    break;
                case "Fast":
                    giGameLoopSpeed = 40;
                    break;
                default:
                    giGameLoopSpeed = 66;
            }

            gbWallWrap = (oSelectWallWrap.value == "On") ? true : false;
            gbDeadlyWalls = (oSelectDeadlyWalls.value == "On") ? true : false;
            gbDeadlyWallsDeadlyTails = (oSelectDeadlyTails.value == "On") ? true : false;
            gbDiagonalMovement = (oSelectDiagonalMovement.value == "On") ? true : false;

            // Todo:
            //selectWallWrap
            //selectDeadlyWalls
            //selectDeadlyTails
            //selectDiagonalMovement
            //selectMaze
            //selectEnemies
            
            TogglePause();
            UpdateScoreboard(ogPlayer[0]);

            oBtnStart.disabled = true;
        }
        function InitializePlayers(ogPlayer) {
            for (let iLoop = ogPlayer.length; iLoop--;) // Reverse loop for the win
            {
                ogPlayer[iLoop] = new Nibbler();
                ogPlayer[iLoop].Name += (iLoop + 1);
                ogPlayer[iLoop].SetSpawnPoint();
            }

            if (ogPlayer.length > 1) {
                // Override Player Two Input Keys
                ogPlayer[1].KeyLeft = 65; // "A"
                ogPlayer[1].KeyUp = 87; // "W"
                ogPlayer[1].KeyRight = 68; // "D"
                ogPlayer[1].KeyDown = 83; // "S"
                ogPlayer[1].fillStyle = "yellow";
            }

            if (ogPlayer.length > 2) {
                // Override Player Two Input Keys
                ogPlayer[2].KeyLeft = 74; // "A"
                ogPlayer[2].KeyUp = 73; // "W"
                ogPlayer[2].KeyRight = 76; // "D"
                ogPlayer[2].KeyDown = 75; // "S"
                ogPlayer[2].fillStyle = "BlueViolet ";
            }

            if (ogPlayer.length > 3) {
                // Override Player Two Input Keys
                ogPlayer[3].KeyLeft = 100; // "A"
                ogPlayer[3].KeyUp = 104; // "W"
                ogPlayer[3].KeyRight = 102; // "D"
                ogPlayer[3].KeyDown = 101; // "S"
                ogPlayer[3].fillStyle = "HotPink ";
            }
        }
        function InitializePellets(ogPellet) {

            for (let iLoop = ogPellet.length; iLoop--;) {
                ogPellet[iLoop] = new Pellet();
                ogPellet[iLoop].SetSpawnPoint();
            }
        }

        function GameLoop() {

            for (let iLoop = ogPlayer.length; iLoop--;) // Reverse loop for the win
            {
                HandlePlayer(ogPlayer[iLoop]);
            }

            DrawGrid();

            ogPlayer.forEach(DrawPlayer);
            ogPlayer.forEach(Nibbler.UpdateTail);
        }

        function HandlePlayer(oPlayer) {

            if (oPlayer.Dead || (oPlayer.DirectionX === 0 && oPlayer.DirectionY === 0)) {
                return;
            }

            oPlayer.PositionX += oPlayer.DirectionX;
            oPlayer.PositionY += oPlayer.DirectionY;

            if (gbWallWrap) {
                if (oPlayer.PositionX < 1) {
                    oPlayer.PositionX = giArenaSquaresX - 1;
                } else if (oPlayer.PositionX >= giArenaSquaresX) {
                    oPlayer.PositionX = 1;
                } else if (oPlayer.PositionY < 1) {
                    oPlayer.PositionY = giArenaSquaresY - 1;
                } else if (oPlayer.PositionY > giArenaSquaresY - 1) {
                    oPlayer.PositionY = 1;
                }
            } else {
                let bHitWall = false;

                if (oPlayer.PositionX < 1) {
                    oPlayer.PositionX = 1;
                    oPlayer.DirectionX = 0;
                    oPlayer.DirectionY = Math.random() < 0.5 ? -1 : 1;
                    bHitWall = true;
                } else if (oPlayer.PositionX >= giArenaSquaresX) {
                    oPlayer.PositionX = giArenaSquaresX - 1;
                    oPlayer.DirectionX = 0;
                    oPlayer.DirectionY = Math.random() < 0.5 ? -1 : 1;
                    bHitWall = true;
                } else if (oPlayer.PositionY < 1) {
                    oPlayer.PositionY = 1;
                    oPlayer.DirectionY = 0;
                    oPlayer.DirectionX = Math.random() < 0.5 ? -1 : 1;
                    bHitWall = true;
                } else if (oPlayer.PositionY > giArenaSquaresY - 1) {
                    oPlayer.PositionY = giArenaSquaresY - 1;
                    oPlayer.DirectionY = 0;
                    oPlayer.DirectionX = Math.random() < 0.5 ? -1 : 1;
                    bHitWall = true;
                }

                if (bHitWall && gbDeadlyWalls) {
                    NibblerDied(oPlayer);
                    return;
                }
            }
            function NibblerDied (oPlayer) {
                oPlayer.Dead = true;
                oPlayer.DirectionX = 0;
                oPlayer.DirectionY = 0;
                oPlayer.TailLength = giMinimumTailLength;

                if (--oPlayer.Lives > 0) {
                    oPlayer.SetSpawnPoint();
                    setTimeout(function () { oPlayer.Dead = false;}, 2000, oPlayer);
                }

                UpdateScoreboard(oPlayer);

            }

            // Check to see if the pellet was eaten
            for (let iLoop = ogPellet.length; iLoop--;) {
                if (ogPellet[iLoop].PositionX === oPlayer.PositionX && ogPellet[iLoop].PositionY === oPlayer.PositionY) {
                    ogPellet[iLoop].Eatten(oPlayer);
                    delete ogPellet[iLoop];
                    window.ogPellet[iLoop] = new Pellet();
                    ogPellet[iLoop].SetSpawnPoint();

                    UpdateScoreboard(oPlayer);
                }
            }
        }

        function KeydownEvent(oEvent) {

            if (CheckForSpecialKeys(oEvent)) {
                return;
            } else {
                if (!gbGamePaused && ogPlayer) {
                    for (let iLoop = ogPlayer.length; iLoop--;) // Reverse loop for the win
                    {
                        if (CheckForKeyEvents(oEvent, ogPlayer[iLoop])) {
                            break;
                        }
                    }
                }
            }
        }

        function CheckForSpecialKeys(oEvent) {

            switch (oEvent.keyCode) {
                case 32: // Space
                case 80: // "P"
                case 27: // "M"
                case 77: // Escape
                    TogglePause();
                default:
                    return false;
            }

            return true;
        }

        function CheckForKeyEvents(oEvent, oPlayer) {

            switch (oEvent.keyCode) {
                case oPlayer.KeyLeft:
                    oPlayer.DirectionX = -1;
                    oPlayer.DirectionY = 0;
                    break;
                case oPlayer.KeyUp:
                    oPlayer.DirectionX = 0;
                    oPlayer.DirectionY = -1;
                    break;
                case oPlayer.KeyRight:
                    oPlayer.DirectionX = 1;
                    oPlayer.DirectionY = 0;
                    break;
                case oPlayer.KeyDown:
                    oPlayer.DirectionX = 0;
                    oPlayer.DirectionY = 1;
                    break;
                default:
                    return false;
            }

            return true;
        }

        function ClickEvent(event) {

            if (gbGamePaused) {
                return;
            }

            let iXOffset = Math.abs(ogPlayer[0].PositionX * giGridSize - event.pageX);
            let iYOffset = Math.abs(ogPlayer[0].PositionY * giGridSize - event.pageY);

            if (iXOffset >= iYOffset && ogPlayer[0].PositionX * giGridSize < event.pageX) {
                ogPlayer[0].DirectionX = 1;
                ogPlayer[0].DirectionY = 0;
            } else if (iXOffset >= iYOffset) {
                ogPlayer[0].DirectionX = -1;
                ogPlayer[0].DirectionY = 0;
            } else if (iXOffset < iYOffset && ogPlayer[0].PositionY * giGridSize < event.pageY) {
                ogPlayer[0].DirectionY = 1;
                ogPlayer[0].DirectionX = 0;
            } else if (iXOffset < iYOffset) {
                ogPlayer[0].DirectionY = -1;
                ogPlayer[0].DirectionX = 0;
            }
        }

        function TogglePause() {

            if (gbGamePaused && !ogPlayer) return;

            // Pause/unPause
            oDivGameMenu.classList.toggle("showGameMenu");
            oDivScoreboard.classList.toggle("modal-blur");
            canvArena.classList.toggle("modal-blur");

            gbGamePaused = !gbGamePaused;

            if (gbGamePaused) {
                clearInterval(ogGameLoop);
                clearInterval(ogCountdownTimer);
                Sounds.Crawlig.pause();
                Sounds.Pause.play();
                addClass(oDivTime, "blink_me");
                oBtnStart.disabled = false;
            } else {
                Sounds.Crawlig.play();
                Sounds.Crawlig.loop = true;
                ogGameLoop = setInterval(GameLoop, giGameLoopSpeed);

                if (oSelectTime.value == "true") {
                ogCountDownTime = new Date().setTime(new Date().getTime() + giTimeRemaining);
                ogCountdownTimer = setInterval(CountdownTimer, 500);
            }

            removeClass(oDivTime, "blink_me");
            }
        }
        function ResizeEvent() {
            // Runs each time the DOM window resize event fires.
            // Resets the canvas dimensions to match window,
            // then draws the new borders accordingly.
            giGridHeight = window.innerHeight - oDivScoreboard.offsetHeight;

            canvArena.width = window.innerWidth;
            canvArena.height = giGridHeight;

            window.giArenaSquaresX = Math.floor(window.innerWidth / giGridSize);
            window.giArenaSquaresY = Math.floor(giGridHeight / giGridSize);

            DrawGrid();
        }

        function DrawGrid() {
            ctxArena.fillStyle = "black";
            ctxArena.fillRect(0, 0, window.innerWidth, giGridHeight);

            ctxArena.strokeStyle = 'orange';
            ctxArena.lineWidth = giGridSize / 2;
            ctxArena.strokeRect(0, 0, window.innerWidth, giGridHeight);

            if (ogPellet) {
                ogPellet.forEach(DrawPellet);
            }
        }

        function DrawPlayer(oPlayer) {
            ctxArena.fillStyle = oPlayer.fillStyle;

            if (oPlayer.Trail.length === 0) {
                ctxArena.fillRect(oPlayer.PositionX * giGridSize,
                    oPlayer.PositionY * giGridSize,
                    giGridSize - 2,
                    giGridSize - 2);
            } else {
                let iSegmentToExclude = oPlayer.Trail.length - 1;
                for (let iLoop = oPlayer.Trail.length; iLoop--;) {
                    ctxArena.fillRect(oPlayer.Trail[iLoop].x * giGridSize,
                        oPlayer.Trail[iLoop].y * giGridSize,
                        giGridSize - 2,
                        giGridSize - 2);

                    // Check to see if the player encountered their tale
                    // We exclude the segment behind the head since they couldn't run into that
                    // easily and it makes wall calculations much easier
                    if (iLoop !== iSegmentToExclude &&
                        oPlayer.Trail[iLoop].x === oPlayer.PositionX && oPlayer.Trail[iLoop].y === oPlayer.PositionY) {
                        oPlayer.TailLength = giMinimumTailLength;
                    }
                }
            }
        }

        function DrawPellet(oPellet) {

            // Draw the pellet
            ctxArena.lineWidth = 2;
            ctxArena.strokeStyle = oPellet.strokeStyle;
            ctxArena.fillStyle = oPellet.fillStyle;
            ctxArena.beginPath();
            ctxArena.arc(oPellet.PositionX * giGridSize + (giGridSize / 2),
                oPellet.PositionY * giGridSize + (giGridSize / 2),
                giGridSize / 2.8,
                0,
                2 * Math.PI);
            ctxArena.fill();
            ctxArena.stroke();
        }

        function DrawBegin() {
            ctxArena.font = giGridSize + "px Comic Sans MS";
            ctxArena.fillStyle = "blue";
            ctxArena.textAlign = "center";
            ctxArena.fillText("Click to Begin", window.innerWidth / 2, giGridHeight / 2);
        }

        function UpdateScoreboard(oPlayer) {
            oDivPlayer.innerText = oPlayer.Name;
            oDivScore.innerText = oPlayer.Score;
            oDivLives.innerText = "Lives " + oPlayer.Lives;

            for (let iLoop = ogPlayer.length; iLoop--;) {
                if (ogPlayer[iLoop].Score > oDivHighScore.innerText) {
                    oDivHighScorePlayer.innerText = `HIGHSCORE (${oPlayer.Name})`;
                    oDivHighScore.innerText = oPlayer.Score;
                }
            }
        }

        function CountdownTimer() {

            // Find the time remaining between now and the count down date
            giTimeRemaining = ogCountDownTime - new Date().getTime();
            let iSeconds = Math.floor(giTimeRemaining / 1000);

            oDivTime.innerHTML = `TIME ${iSeconds}`;

            if (iSeconds === 10) {
                addClass(oDivTime, "blink_me");
            }

            // If the count down is finished, write some text
            if (giTimeRemaining < 0) {
                clearInterval(ogCountdownTimer);
                oDivTime.innerHTML = "TIME EXPIRED";
                addClass(oDivTime, "blink_me");
                TogglePause();
            }
        }

        function hasClass(ele, cls) {
            return !!ele.className.match(new RegExp('(\\s|^)' + cls + '(\\s|$)'));
        }

        function addClass(ele, cls) {
            if (!hasClass(ele, cls)) ele.className += ` ${cls}`;
        }

        function removeClass(ele, cls) {
            if (hasClass(ele, cls)) {
                var reg = new RegExp('(\\s|^)' + cls + '(\\s|$)');
                ele.className = ele.className.replace(reg, ' ');
            }
        }

    </script>

</BODY>
</HTML>
